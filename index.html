<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IPD Ölçer – Lite (Düşük FPS/Çözünürlük)</title>
<style>
  :root{--bg:#0b0b0c;--card:#121317;--b:#2a2c34;--txt:#e8e9ee;--pri:#2b82ff}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--txt);font:14px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #wrap{max-width:900px;margin:16px auto;padding:12px}
  h1{margin:0 0 10px;font-size:18px}
  #row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  video,canvas{max-width:100%;border:1px solid #333;border-radius:10px}
  #panel{flex:1 1 260px;min-width:260px;background:var(--card);border:1px solid var(--b);border-radius:12px;padding:12px}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle;margin-right:6px}
  .row{margin:8px 0} code{background:#1a1d26;padding:2px 6px;border-radius:6px}
  #log{white-space:pre-wrap;font:12px ui-monospace, SFMono, Menlo, Consolas; background:#0e1117; border:1px solid #2a2c34; border-radius:8px; padding:8px; max-height:160px; overflow:auto}
  #starter{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000a;backdrop-filter:blur(2px)}
  #starter .card{background:#111823;border:1px solid #2a2c34;border-radius:12px;padding:16px;max-width:420px;text-align:center}
  #starter button{cursor:pointer;background:var(--pri);color:#fff;border:0;border-radius:10px;padding:10px 16px;margin-top:10px}
</style>
</head>
<body>
<div id="wrap">
  <h1>IPD Ölçer (Lite)</h1>
  <div id="row">
    <div>
      <video id="cam" autoplay playsinline muted></video>
      <canvas id="view"></canvas>
    </div>
    <div id="panel">
      <div class="row"><span class="dot" id="qdot" style="background:#e33"></span>
        <b id="ipd">IPD: —</b>
      </div>
      <div class="row">Durum: <code id="status">hazır</code></div>
      <div id="log" class="row">Hazır…</div>
    </div>
  </div>
</div>

<div id="starter">
  <div class="card">
    <div style="font-weight:600;margin-bottom:6px">Kamera izni gerekiyor</div>
    <div style="opacity:.8">HTTPS/localhost üzerinde tek dokunuşla başlar.</div>
    <button id="btnStart">Başlat</button>
  </div>
</div>

<script type="module">
const logEl = document.getElementById('log'); const statusEl = document.getElementById('status');
const log = m => { logEl.textContent += "\\n"+m; logEl.scrollTop = logEl.scrollHeight; };
const setStatus = s => statusEl.textContent = s;
const setQ = (c)=> document.getElementById('qdot').style.background = c;

const TARGET_FPS_BASE = 10;          // hedef fps
let targetFps = TARGET_FPS_BASE;     // adaptif düşecek/yükselecek
let frameBudget = 1000/targetFps;

let PROC_W = 360;                    // işleme genişliği (adaptif olarak 320'ye düşebilir)
const MIN_PROC_W = 320;

const vid = document.getElementById('cam');
const cvs = document.getElementById('view');
const ctx = cvs.getContext('2d');
const ipdEl = document.getElementById('ipd');
const starter = document.getElementById('starter');
const btnStart = document.getElementById('btnStart');

let landmarker=null, running=false, paused=false;
let lastT=0, ema=null, alpha=0.25, medianWin=[], MED_N=15;

function fmt(n){ return (n!=null && isFinite(n)) ? n.toFixed(1) : '—'; }
function pushMedian(win, v, N){ win.push(v); if(win.length>N) win.shift(); const s=[...win].sort((a,b)=>a-b); const m=(s.length-1)/2; return (s.length%2)? s[(s.length-1)/2] : 0.5*(s[Math.floor(m)]+s[Math.ceil(m)]); }
const v2 = (p)=>[p.x*cvs.width, p.y*cvs.height];
const dist = (a,b)=>Math.hypot(a[0]-b[0], a[1]-b[1]);

async function initCam(){
  log("Kamera açılıyor (640×360 @≤15fps) …");
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:"user",
      width:{ ideal: 640, max: 640 },
      height:{ ideal: 360, max: 360 },
      frameRate:{ ideal: 15, max: 15 }
    },
    audio:false
  });
  const track = stream.getVideoTracks()[0];
  try{
    await track.applyConstraints({
      width:{ exact: 640 }, height:{ exact: 360 },
      frameRate:{ max: 15 },
      advanced:[{ zoom: 1.0 }, { resizeMode: "none" }]
    });
  }catch{}
  vid.srcObject = stream; await vid.play();
  const aspect = vid.videoWidth / vid.videoHeight;
  cvs.width = PROC_W; cvs.height = Math.round(PROC_W/aspect);
  log("Kamera tamam: "+JSON.stringify(track.getSettings()));
}

async function initMP(){
  setStatus("mediapipe yükleniyor…"); log("MediaPipe yükleniyor…");
  const { FaceLandmarker, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest");
  const fs = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm");
  landmarker = await FaceLandmarker.createFromOptions(fs, {
    baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task" },
    outputFaceBlendshapes:false, runningMode:"VIDEO", numFaces:1
  });
  setStatus("hazır"); log("MediaPipe hazır.");
}

function irisCR(lm,left=true){
  const c = left?468:473, rim = left?[469,470,471,472]:[474,475,476,477];
  const C=lm[c];
  if(C && lm[rim[0]]){
    const C2=v2(C); let R=0,n=0; for(const i of rim){ if(lm[i]){ const p=v2(lm[i]); R+=Math.hypot(p[0]-C2[0], p[1]-C2[1]); n++; } }
    return {center:C2, r:(n?R/n:0), ok:true};
  }
  // Minimal fallback (göz konturu)
  const ids = left?[33,133,159,145]:[263,362,386,374];
  let sx=0, sy=0, n=0; for(const i of ids){ if(lm[i]){ sx+=lm[i].x*cvs.width; sy+=lm[i].y*cvs.height; n++; } }
  if(!n) return {center:[0,0], r:0, ok:false};
  const cen=[sx/n, sy/n]; return {center:cen, r:8, ok:false}; // kaba değer
}

function faceOK(lm){
  if(!lm[33]||!lm[263]) return {ok:false, ang:999};
  const L=v2(lm[33]), R=v2(lm[263]);
  const eyeSlope = Math.abs(Math.atan2(R[1]-L[1], R[0]-L[0])*180/Math.PI);
  return {ok: eyeSlope<=20, ang: eyeSlope};
}

function drawLR(Lc,Rc){
  ctx.fillStyle="#00ffff"; ctx.beginPath(); ctx.arc(Lc[0],Lc[1],3,0,6.283); ctx.fill();
  ctx.beginPath(); ctx.arc(Rc[0],Rc[1],3,0,6.283); ctx.fill();
  ctx.strokeStyle="#00ffff"; ctx.lineWidth=2; ctx.beginPath();
  ctx.moveTo(Lc[0],Lc[1]); ctx.lineTo(Rc[0],Rc[1]); ctx.stroke();
}

let avgProcMs = 0;
function adaptPerf(procMs){
  // hareketli ortalama
  avgProcMs = avgProcMs ? 0.8*avgProcMs + 0.2*procMs : procMs;
  // FPS düşür
  if (avgProcMs > 80 && targetFps > 8) { targetFps = 8; frameBudget = 1000/targetFps; setStatus(`düşük güç (fps=${targetFps})`); }
  if (avgProcMs > 120 && PROC_W > MIN_PROC_W) {
    PROC_W = MIN_PROC_W;
    const aspect = vid.videoWidth/vid.videoHeight;
    cvs.width = PROC_W; cvs.height = Math.round(PROC_W/aspect);
    setStatus(`çok düşük güç (proc_w=${PROC_W})`);
  }
}

function loop(t){
  if(!running) return;
  requestAnimationFrame(loop);
  if (!landmarker || !vid.videoWidth) return;
  if (t - lastT < frameBudget) return;
  lastT = t;

  const t0 = performance.now();
  try{
    ctx.drawImage(vid,0,0,cvs.width,cvs.height);
    const res = landmarker.detectForVideo(vid, t0);
    if (res.faceLandmarks?.length){
      const lm = res.faceLandmarks[0];
      const L=irisCR(lm,true), R=irisCR(lm,false);
      drawLR(L.center,R.center);
      const ok = faceOK(lm);
      if(!ok.ok){ ipdEl.textContent="IPD: —"; setQ("#e39"); return; }
      const gapPx = dist(L.center, R.center);
      const med = pushMedian(medianWin, gapPx, MED_N);
      ema = (ema==null)? med : alpha*med + (1-alpha)*ema;
      ipdEl.textContent = `IPD(px) ≈ ${fmt(ema)}  (kalibrasyonsuz)`;
      setQ("#3ecf5e");
    } else {
      ipdEl.textContent="IPD: — (yüz yok)"; setQ("#e33");
    }
  }catch(e){ log("Hata: "+e); }
  adaptPerf(performance.now() - t0);
}

/* Başlat */
async function startAll(){
  try{
    starter.style.display='none';
    await initCam();
    await initMP();
    running = true; requestAnimationFrame(loop);
  }catch(e){
    log("Başlatılamadı: "+e);
    starter.style.display='';
  }
}
btnStart.onclick = startAll;
// otomatik dene (jest gerekirse overlay kalır)
document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(()=>startAll().catch(()=>{}), 300); });
// sayfa gizlenirse gereksiz yükü kes
document.addEventListener('visibilitychange', ()=>{ running = !document.hidden; if(running) requestAnimationFrame(loop); });
</script>
</body>
</html>
