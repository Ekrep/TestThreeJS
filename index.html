<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPD Ölçer • MediaPipe + Kart Kalibrasyonu</title>
  <style>
    :root{--gap:12px;--radius:14px}
    html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial}
    body{display:grid;grid-template-rows:auto 1fr auto;background:#0b0f14;color:#e6edf3}
    header,footer{padding:12px 16px;background:#0e1520;border-bottom:1px solid #182234}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    main{display:grid;grid-template-columns:1fr 360px;gap:var(--gap);padding:var(--gap)}
    #stage{position:relative;background:#000;border-radius:var(--radius);overflow:hidden;min-height:60vh}
    video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #overlay{pointer-events:none}
    .panel{display:flex;flex-direction:column;gap:var(--gap);background:#0e1520;border:1px solid #182234;padding:var(--gap);border-radius:var(--radius)}
    .row{display:flex;align-items:center;gap:8px}
    .btn{appearance:none;border:1px solid #243148;background:#121a27;color:#e6edf3;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .meter{height:10px;background:#141b27;border:1px solid #1e2a3d;border-radius:999px;overflow:hidden}
    .meter>i{display:block;height:100%;width:0;background:#3fb950}
    .cardGuide{position:absolute;inset:auto 50% 16% 50%;transform:translate(-50%,0);width:min(60%,520px);height:40px;border:2px dashed #93c5fd;border-radius:8px;background-color:rgba(59,130,246,.12);backdrop-filter:blur(1px);display:none}
    .cardGrip{position:absolute;top:-12px;bottom:-12px;width:16px;background:#93c5fd;border-radius:6px;cursor:ew-resize}
    .cardGrip.left{left:-10px}.cardGrip.right{right:-10px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#101827;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-weight:600}
    .small{opacity:.8;font-size:12px}
    .warn{color:#fbbf24}
    .ok{color:#34d399}
    .bad{color:#f87171}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <header>
    <h1>IPD Ölçer <span class="small">(MediaPipe Face Landmarker + Kredi Kartı Kalibrasyonu)</span></h1>
  </header>
  <main>
    <section id="stage">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
      <div id="cardGuide" class="cardGuide">
        <div class="cardGrip left"  data-side="left"></div>
        <div class="cardGrip right" data-side="right"></div>
      </div>
    </section>

    <aside class="panel">
      <div class="row" style="justify-content:space-between">
        <button id="startBtn" class="btn">Kamerayı Başlat</button>
        <button id="calBtn" class="btn" disabled>Kalibre Et (Kart)</button>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="pill">Anlık IPD: <span id="ipdLabel" class="mono">--.- mm</span></div>
        <div class="pill">Güven: <span id="qualLabel" class="mono">--%</span></div>
      </div>
      <div>
        <div class="row" style="justify-content:space-between"><span class="small">İzleme Kalitesi</span><span id="qualText" class="small">-</span></div>
        <div class="meter"><i id="qualBar"></i></div>
      </div>
      <div class="row" style="flex-wrap:wrap;gap:6px 8px">
        <label class="small">Pencere Boyutu (ortalama): <input id="winN" type="number" min="3" max="60" value="15" style="width:64px"/></label>
        <label class="small">EMA α: <input id="alpha" type="number" step="0.05" min="0.05" max="0.9" value="0.35" style="width:64px"/></label>
        <label class="small">FPS: <span id="fps" class="mono">-</span></label>
      </div>
      <details>
        <summary>İpucu & Notlar</summary>
        <ul>
          <li>Kalibrasyonda bir <b>kredi/kimlik kartını</b> yatay tutup, ekrandaki mavi çerçevenin <b>genişliğini</b> kartla eşleştir.</li>
          <li>Kalibrasyondan sonra kartı indirebilirsin; sistem, ileri/geri hareketleri <b>otomatik telafi eder</b>.</li>
          <li>Başını aşırı eğme/eğim verme. Göz çevresi net görünsün.</li>
        </ul>
      </details>
      <div class="small">Sürüm: <span class="mono">v1.0</span></div>
    </aside>
  </main>
  <footer>
    <span class="small">Gizlilik: Video akışı cihazı terk etmez; her şey yerelde çalışır.</span>
  </footer>

<script type="module">
  import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

  // === Sabitler ===
  const CARD_MM = 85.60; // ISO/IEC 7810 ID-1 kart genişliği (mm)
  const W = 1280, H = 720; // video/çizim hedef çözünürlüğü

  // === DOM ===
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const calBtn = document.getElementById('calBtn');
  const ipdLabel = document.getElementById('ipdLabel');
  const qualLabel = document.getElementById('qualLabel');
  const qualBar = document.getElementById('qualBar');
  const qualText = document.getElementById('qualText');
  const winNEl = document.getElementById('winN');
  const alphaEl = document.getElementById('alpha');
  const fpsEl = document.getElementById('fps');
  const cardGuide = document.getElementById('cardGuide');

  overlay.width = W; overlay.height = H;

  // === Durum ===
  let landmarker, running=false, lastT=performance.now();
  let ema=null, alpha=parseFloat(alphaEl.value);
  let windowN=parseInt(winNEl.value);
  let history=[]; // son N IPD mm
  let cardPx=null; // kalibrasyonda (piksel) kart genişliği
  let dragging=null; // 'left' | 'right'

  // === Yardımcılar ===
  const lerp=(a,b,t)=>a+(b-a)*t;
  const dist=(a,b)=>Math.hypot(a.x-b.x, a.y-b.y);
  const avg=(arr)=>arr.reduce((s,v)=>s+v,0)/arr.length;
  const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  const nowMs=()=>performance.now();

  function idx(pt){ // normalize → piksel
    return {x: pt.x * W, y: pt.y * H};
  }

  function eyeCenter(lms, ids){
    // 468-topolojisi için sağlam 4 nokta: üst-alt + iç-dış köşe
    const pts = ids.map(i => idx(lms[i]));
    const cx = avg(pts.map(p=>p.x));
    const cy = avg(pts.map(p=>p.y));
    return {x:cx,y:cy};
  }

  // Sol göz (33,133,159,145) — Sağ göz (362,263,386,374)
  const L_IDS=[33,133,159,145];
  const R_IDS=[362,263,386,374];

  function drawFace(landmarks){
    ctx.clearRect(0,0,W,H);
    if(!landmarks) return;
    const l = eyeCenter(landmarks, L_IDS);
    const r = eyeCenter(landmarks, R_IDS);

    // göz merkezleri + hat
    ctx.lineWidth = 3; ctx.strokeStyle = 'rgba(255,255,255,.8)';
    ctx.fillStyle = 'rgba(59,130,246,.9)';
    ctx.beginPath(); ctx.moveTo(l.x,l.y); ctx.lineTo(r.x,r.y); ctx.stroke();
    ctx.beginPath(); ctx.arc(l.x,l.y,6,0,Math.PI*2); ctx.arc(r.x,r.y,6,0,Math.PI*2); ctx.fill();

    // kart kılavuzu
    if(cardGuide.style.display==='block'){
      // nothing extra; overlay elemanı kendi çiziliyor
    }
  }

  function updateUI(quality, ipdMm){
    const qPct = Math.round(clamp(quality*100,0,100));
    qualLabel.textContent = qPct+"%";
    qualBar.style.width = qPct+"%";
    qualText.textContent = qPct>80? 'Çok iyi' : qPct>60? 'İyi' : qPct>40? 'Orta' : 'Düşük';

    if(ipdMm){
      ipdLabel.textContent = ipdMm.toFixed(1)+" mm";
    }
  }

  function stableMean(pushVal){
    history.push(pushVal);
    if(history.length>windowN) history.shift();
    // uç değer kırpma: orta %80
    const sorted=[...history].sort((a,b)=>a-b);
    const cut = Math.max(1, Math.floor(sorted.length*0.1));
    const core = sorted.slice(cut, sorted.length-cut);
    return avg(core.length?core:sorted);
  }

  // FPS ölçer
  let frames=0, fps=0;
  setInterval(()=>{ fps=fps*0.5 + frames*0.5; frames=0; fpsEl.textContent = Math.round(fps); }, 1000);

  // === Kamera & Model ===
  async function initCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({video:{width:W,height:H,facingMode:'user'}, audio:false});
    video.srcObject = stream;
    await video.play();
    calBtn.disabled=false;
  }

  async function initModel(){
    const files = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm");
    landmarker = await FaceLandmarker.createFromOptions(files,{
      baseOptions:{
        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task"
      },
      runningMode: 'VIDEO',
      numFaces: 1,
      outputFaceBlendshapes:false,
      outputFacialTransformationMatrixes:false
    });
  }

  // === Kalibrasyon (kart genişliği piksel) ===
  function enableCardGuide(){
    cardGuide.style.display = 'block';
    // başlangıç genişliği: videonun %40'ı
    const guideW = Math.min(W*0.6, 520);
    cardGuide.style.width = guideW + 'px';
    cardGuide.style.left = '50%';
  }

  function getCardPx(){
    const rect = cardGuide.getBoundingClientRect();
    const stage = overlay.getBoundingClientRect();
    // ölçek farklı ise normalize et (canvas piksel alanına dön)
    const px = rect.width * (W/stage.width);
    return px;
  }

  // Drag kulpları
  let startX=0, startW=0;
  function onDragStart(e){
    const side = e.target.getAttribute('data-side');
    if(!side) return;
    dragging = side;
    startX = (e.touches? e.touches[0].clientX : e.clientX);
    startW = cardGuide.getBoundingClientRect().width;
    e.preventDefault();
  }
  function onDragMove(e){
    if(!dragging) return;
    const x = (e.touches? e.touches[0].clientX : e.clientX);
    const dx = x - startX;
    const curW = cardGuide.getBoundingClientRect().width;
    const nextW = clamp(dragging==='right'? (startW+dx) : (startW-dx), 60, Math.min(window.innerWidth*0.9, 900));
    cardGuide.style.width = nextW + 'px';
  }
  function onDragEnd(){ dragging=null; }
  cardGuide.addEventListener('mousedown', onDragStart); cardGuide.addEventListener('touchstart', onDragStart, {passive:false});
  window.addEventListener('mousemove', onDragMove, {passive:false}); window.addEventListener('touchmove', onDragMove, {passive:false});
  window.addEventListener('mouseup', onDragEnd); window.addEventListener('touchend', onDragEnd);

  // === Ana Döngü ===
  let lastVideoTime = -1;
  async function loop(){
    if(!running){ requestAnimationFrame(loop); return; }
    frames++;

    // MediaPipe video timestamp (ms)
    const vt = Math.trunc(video.currentTime * 1000);
    if(vt === lastVideoTime){ requestAnimationFrame(loop); return; }
    lastVideoTime = vt;

    const res = await landmarker.detectForVideo(video, vt);
    const face = res.faceLandmarks?.[0];

    if(face){
      // Göz merkezleri ve kalite skoru
      const l = eyeCenter(face, L_IDS);
      const r = eyeCenter(face, R_IDS);
      const eyePx = dist(l,r);

      // basit kalite metriği: gözler arası piksel ve göz dikey açıklığı
      const lOpen = Math.abs(idx(face[159]).y - idx(face[145]).y);
      const rOpen = Math.abs(idx(face[386]).y - idx(face[374]).y);
      let quality = clamp((eyePx/140) * 0.6 + ((lOpen+rOpen)/40)*0.4, 0, 1);

      drawFace(face);

      // Kalibre ise anlık IPD (mm)
      let ipdMmInst = null;
      if(cardPx){
        const mmPerPx = CARD_MM / cardPx; // kalibrasyon düzlemi → mm/px
        // Derinlik hareketi zaten E(t)*mm/px ile iptal olur (E∝1/Z)
        ipdMmInst = eyePx * mmPerPx;
        const mean = stableMean(ipdMmInst);
        ema = (ema==null)? mean : lerp(ema, mean, alpha);
        updateUI(quality, ema);
      } else {
        updateUI(quality, null);
      }
    } else {
      ctx.clearRect(0,0,W,H);
      updateUI(0, ema);
    }

    requestAnimationFrame(loop);
  }

  // === Etkileşimler ===
  startBtn.addEventListener('click', async ()=>{
    startBtn.disabled = true;
    await initCamera();
    await initModel();
    running = true;
    requestAnimationFrame(loop);
  });

  calBtn.addEventListener('click', ()=>{
    if(cardGuide.style.display !== 'block'){
      enableCardGuide();
      calBtn.textContent = 'Kalibrasyonu Onayla';
    } else {
      // genişliği kilitle
      cardPx = getCardPx();
      cardGuide.style.display='none';
      calBtn.textContent = 'Yeniden Kalibre Et';
    }
  });

  winNEl.addEventListener('change', ()=>{
    windowN = clamp(parseInt(winNEl.value)||15, 3, 60);
    history.length = 0; // sıfırla
  });
  alphaEl.addEventListener('change', ()=>{
    alpha = clamp(parseFloat(alphaEl.value)||0.35, 0.05, 0.9);
  });

  // İlk durumda kart kulplarını fareyle tutmak için sahneye tıklanabilirlik ver
  document.querySelectorAll('.cardGrip').forEach(el=>{
    el.addEventListener('mousedown', onDragStart);
    el.addEventListener('touchstart', onDragStart, {passive:false});
  });

</script>
</body>
</html>
